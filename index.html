<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Podgląd FBX z three.js</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body { margin: 0; overflow: hidden; background: #222; }
        #info { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: #fff; font-size: 1.2rem; z-index: 1; }
        canvas { display: block; }
        /* spinner */
        #spinner { position: absolute; bottom: 80px; left: 50%; width: 40px; height: 40px; margin-left: -20px; border: 4px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; z-index: 1; }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* animated dots for processing */
        #info.processing::after { content: ''; margin-left: 4px; animation: dots 1s steps(1,end) infinite; }
        @keyframes dots { 0% { content: ''; } 33% { content: '.'; } 66% { content: '..'; } 100% { content: '...'; } }
    </style>
</head>
<body>
    <div id="info">Wyświetlanie pliku FBX: <b>workshop_01_001_KM.fbx</b></div>
    <div id="spinner"></div>
    <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.module.js"
      }
    }
    </script>
    <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.154.0/examples/jsm/controls/OrbitControls.js';
    import { FBXLoader } from 'https://cdn.jsdelivr.net/npm/three@0.154.0/examples/jsm/loaders/FBXLoader.js';

    let camera, scene, renderer, controls;
    init();
    animate();

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(2, 2, 4);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(10, 10, 10);
        scene.add(directionalLight);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        controls = new OrbitControls(camera, renderer.domElement);
        
        // Loader FBX
        const loader = new FBXLoader();
        loader.load('workshop_01_001_KM.fbx',
            function (object) {
                // Tworzymy nowy, jednolity materiał
                const uniformMaterial = new THREE.MeshStandardMaterial({
                    color: 0x808080,  // Kolor szary
                    roughness: 0.7,    // Szorstkość powierzchni
                    metalness: 0.3     // Metaliczność
                });

                object.traverse(function (child) {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                        // Zastępujemy materiał obiektu nowym, jednolitym materiałem
                        child.material = uniformMaterial;
                    }
                });
                // ukryj spinner i przestań animować dots
                const infoEl = document.getElementById('info');
                document.getElementById('spinner').style.display = 'none';
                infoEl.classList.remove('processing');
                scene.add(object);
                infoEl.innerText = 'Wyświetlanie pliku FBX: workshop_01_001.fbx';
                // centrowanie kamery
                const box = new THREE.Box3().setFromObject(object);
                const center = box.getCenter(new THREE.Vector3());
                camera.lookAt(center);
                controls.target.copy(center);
            },
            function (xhr) {
                const percent = (xhr.loaded / xhr.total) * 100;
                const infoEl = document.getElementById('info');
                if (percent < 100) {
                    infoEl.classList.remove('processing');
                    infoEl.innerText = 'Ładowanie: ' + Math.round(percent) + '%';
                } else {
                    infoEl.innerText = 'Przetwarzanie modelu';
                    infoEl.classList.add('processing');
                }
            },
            function (error) {
                console.error('Błąd ładowania FBX:', error);
                document.getElementById('info').innerText = 'Błąd ładowania modelu';
            }
        );

        window.addEventListener('resize', onWindowResize);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        if (controls) controls.update();
        renderer.render(scene, camera);
    }
    </script>
</body>
</html>
